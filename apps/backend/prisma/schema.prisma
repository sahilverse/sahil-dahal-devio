generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum CommunityType {
  PUBLIC
  PRIVATE
  RESTRICTED
}

enum CodeType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum ProviderType {
  GOOGLE
  GITHUB
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
  ADMIN_DISABLED
  PENDING_DELETION
}

enum SessionType {
  AUTHENTICATION
  PASSWORD_RESET
}

model User {
  id            String        @id @default(cuid())
  firstName     String        @map("first_name")
  lastName      String        @map("last_name")
  email         String        @unique
  username      String        @unique
  password      String?
  role          Role          @default(USER)
  avatarUrl     String?       @map("avatar_url")
  bannerUrl     String?       @map("banner_url")
  accountStatus AccountStatus @default(ACTIVE) @map("account_status")

  emailVerified DateTime? @map("email_verified")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  verificationTokens VerificationToken[]
  accounts           Account[]
  sessions           Session[]
  statusHistory      AccountStatusHistory[]
  profile            Profile?

  @@index([username])
  @@index([email])
  @@index([role])
  @@index([accountStatus])
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")

  title   String?
  bio     String?
  city    String?
  country String?

  socials Json?

  skills String[]

  birthday DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([skills])
}

model VerificationToken {
  id   String   @id @default(cuid())
  code String
  type CodeType

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([expiresAt])
  @@index([code])
  @@index([type])
  @@index([code, type])
}

model Account {
  userId            String       @map("user_id")
  type              String
  provider          ProviderType
  providerAccountId String       @map("provider_account_id")
  id_token          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
}

model AccountStatusHistory {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  status      AccountStatus
  reason      String?
  performedBy String?       @map("performed_by")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Session {
  id           String      @id @default(cuid())
  userId       String      @map("user_id")
  sessionToken String      @unique @map("session_token")
  ip           String?
  userAgent    Json?       @map("user_agent")
  isActive     Boolean     @default(true) @map("is_active")
  type         SessionType @default(AUTHENTICATION)

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([ip])
  @@index([createdAt])
  @@index([userId, type])
}
